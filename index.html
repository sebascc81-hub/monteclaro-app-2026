<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti贸n Inmobiliaria - Monteclaro</title>
    <style>
        :root {
            --primary: #2638bf; /* Azul Corporativo */
            --accent: #000000;  /* Negro (Botones/Acci贸n) */
            --bg: #f4f6f8;
            --white: #ffffff;
            /* Estados Sem谩foro */
            --st-pendiente: #ffd700; 
            --st-proceso: #2196f3; 
            --st-completada: #4caf50; 
            --st-cancelada: #f44336;
        }
        /* MODIFICADO: A帽adido flex y min-height para empujar el footer abajo */
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            background-color: var(--bg); 
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh; 
        }
        
        /* --- HEADER Y LOGO --- */
        header { 
            background: var(--primary); 
            color: white; 
            padding: 1.5rem 1rem; 
            display: flex; 
            flex-direction: column; 
            align-items: center;    
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15); 
            text-align: center;
        }
        .header-branding {
            display: flex;
            flex-direction: column; 
            align-items: center;
            gap: 10px; 
            width: 100%;
        }
        .logo {
            width: 400px; 
            max-width: 90%; 
            height: auto;
            object-fit: contain;
        }
        .header-text h1 { 
            margin: 10px 0 5px 0; 
            font-size: 1.8rem; 
            font-weight: 800; 
            text-transform: uppercase;
            letter-spacing: 1px;
            line-height: 1.2; 
        }
        .header-text div { 
            font-size: 1.1rem; 
            font-weight: 400;
            opacity: 0.95; 
        }
        
        #loading {
            margin-top: 10px;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        /* NAVEGACIN */
        .tabs { display: flex; background: white; padding: 0 2rem; border-bottom: 1px solid #ddd; justify-content: center; }
        .tab-btn { background: none; border: none; padding: 15px 25px; cursor: pointer; font-weight: bold; color: #666; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-btn:hover { color: var(--primary); }

        /* CONTENEDOR - MODIFICADO: flex: 1 para ocupar espacio disponible */
        .container { padding: 20px; max-width: 1200px; margin: 0 auto; width: 100%; box-sizing: border-box; flex: 1; }
        .module { display: none; animation: fadeIn 0.3s; }
        .module.active { display: block; }
        
        /* HERRAMIENTAS Y FILTROS */
        .toolbar { background: white; padding: 15px; margin-bottom: 20px; border-radius: 8px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn-new { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-new:hover { opacity: 0.8; }
        .filter-label { font-weight: bold; color: var(--primary); margin-left: 10px; }
        input, select, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; outline: none; }
        input:focus, select:focus { border-color: var(--primary); }
        
        /* TABLAS */
        .table-responsive { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--primary); color: white; text-transform: uppercase; font-size: 0.8rem; font-weight: 600; }
        tr:hover { background: #f9f9f9; cursor: pointer; }
        .badge { padding: 4px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; color: white; display: inline-block; min-width: 80px; text-align: center; }
        
        /* COLORES ESTADO */
        .bg-pendiente { background: var(--st-pendiente); color: black; }
        .bg-proceso { background: var(--st-proceso); }
        .bg-completada { background: var(--st-completada); }
        .bg-cancelada { background: var(--st-cancelada); }

        /* MODALES */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(2px); }
        .modal-content { background: white; margin: 5% auto; width: 90%; max-width: 500px; padding: 0; border-radius: 8px; max-height: 85vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .modal-header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; }
        .modal-body { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; color: #555; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; box-sizing: border-box; }
        .form-group textarea { height: 80px; resize: vertical; }
        
        /* Bloqueados */
        input:disabled, select:disabled, textarea:disabled { background: #e9ecef; cursor: not-allowed; color: #777; border-color: #ddd; }
        
        .modal-footer { padding: 15px 20px; text-align: right; border-top: 1px solid #eee; }
        .btn-save { background: var(--accent); color: white; padding: 10px 25px; border: none; cursor: pointer; border-radius: 4px; font-size: 1rem; }
        .btn-save:disabled { background: #ccc; cursor: wait; }

        /* --- ESTILOS DEL FOOTER (CRDITOS) --- */
        footer {
            background-color: white;
            border-top: 1px solid #e0e0e0;
            padding: 20px;
            text-align: center;
            font-size: 0.9rem;
            color: #666;
            margin-top: 20px;
        }
        footer strong {
            color: var(--primary);
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <header>
        <div class="header-branding">
            <img src="MONTECLARO5.png" alt="Logo Monteclaro" class="logo">
            
            <div class="header-text">
                <h1>GESTION INMOBILIARIA</h1>
                <div>MONTECLARO INMOBILIARIA S.A.S</div>
                <div>901.968.559-8</div>
            </div>
        </div>

        <div id="loading" style="display:none; font-weight:bold;"> Sincronizando...</div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="verModulo('actividades')">ACTIVIDADES</button>
        <button class="tab-btn" onclick="verModulo('clientes')">CLIENTES</button>
    </div>

    <div id="mod-actividades" class="container module active">
        <div class="toolbar">
            <button class="btn-new" onclick="abrirModalActividad(true)">+ Nueva Actividad</button>
            <span class="filter-label">| Filtros:</span>
            <input type="date" id="fActFecha" onchange="renderActividades()" title="Filtrar Fecha">
            <select id="fActResp" onchange="renderActividades()">
                <option value="">Resp: Todos</option>
                <option value="JUAN ROMERO">JUAN ROMERO</option>
                <option value="SEBAS CUERVO">SEBAS CUERVO</option>
            </select>
            <select id="fActEstado" onchange="renderActividades()">
                <option value="">Est: Todos</option>
                <option value="PENDIENTE">PENDIENTE</option>
                <option value="EN PROCESO">EN PROCESO</option>
                <option value="COMPLETADA">COMPLETADA</option>
                <option value="CANCELADA">CANCELADA</option>
            </select>
        </div>
        <div class="table-responsive">
            <table>
                <thead><tr><th>Fecha</th><th>Cliente</th><th>Actividad</th><th>Responsable</th><th>Estado</th><th>Notas</th></tr></thead>
                <tbody id="tblActividades"><tr><td colspan="6" style="text-align:center">Cargando...</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="mod-clientes" class="container module">
        <div class="toolbar">
            <button class="btn-new" onclick="abrirModalCliente(true)">+ Nuevo Cliente</button>
            <span class="filter-label">| Filtros:</span>
            <select id="fCliTipo" onchange="renderClientes()">
                <option value="">Tipo: Todos</option>
                <option value="VENTA">VENTA</option>
                <option value="ADMINISTRACION">ADMINISTRACION</option>
                <option value="CREDITO/SUBSIDIO">CREDITO/SUBSIDIO</option>
            </select>
            <select id="fCliEstado" onchange="renderClientes()">
                <option value="">Est: Todos</option>
                <option value="PENDIENTE">PENDIENTE</option>
                <option value="EN PROCESO">EN PROCESO</option>
                <option value="COMPLETADA">COMPLETADA</option>
                <option value="CANCELADA">CANCELADA</option>
            </select>
        </div>
        <div class="table-responsive">
            <table>
                <thead><tr><th>Nombre</th><th>C茅dula</th><th>Tel茅fono</th><th>Tipo</th><th>Estado</th><th>Notas</th></tr></thead>
                <tbody id="tblClientes"><tr><td colspan="6" style="text-align:center">Cargando...</td></tr></tbody>
            </table>
        </div>
    </div>

    <footer>
        MONTECLARO INMOBILIARIA S.A.S V1.0 &copy; 2026<br>
        Desarrollado por <strong>SEBASTIN CUERVO</strong>
         Desarrollado por <strong>SEBASTIN CUERVO</BR>
    </footer>

    <div id="modalActividad" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="tModalAct">Gesti贸n Actividad</h3><span style="cursor:pointer; font-size:1.5rem;" onclick="cerrarModales()">&times;</span></div>
            <div class="modal-body">
                <input type="hidden" id="actId"><input type="hidden" id="actModo">
                
                <div class="form-group">
                    <label>Cliente (Base de Datos):</label>
                    <select id="actCliente"><option value="">Cargando lista...</option></select>
                </div>
                <div class="form-group"><label>Actividad:</label><textarea id="actDesc" placeholder="Describa la tarea..."></textarea></div>
                <div class="form-group">
                    <label>Responsable:</label>
                    <select id="actResp">
                        <option value="">Seleccione...</option>
                        <option value="JUAN ROMERO">JUAN ROMERO</option>
                        <option value="SEBAS CUERVO">SEBAS CUERVO</option>
                    </select>
                </div>
                
                <div class="form-group" id="divActEst">
                    <label>Estado:</label>
                    <select id="actEst">
                        <option value="PENDIENTE">PENDIENTE</option><option value="EN PROCESO">EN PROCESO</option>
                        <option value="COMPLETADA">COMPLETADA</option><option value="CANCELADA">CANCELADA</option>
                    </select>
                </div>
                <div class="form-group" id="divActNotas"><label>Notas de Seguimiento:</label><textarea id="actNotas"></textarea></div>
            </div>
            <div class="modal-footer">
                <button class="btn-save" onclick="guardarActividad()">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <div id="modalCliente" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="tModalCli">Gesti贸n Cliente</h3><span style="cursor:pointer; font-size:1.5rem;" onclick="cerrarModales()">&times;</span></div>
            <div class="modal-body">
                <input type="hidden" id="cliId"><input type="hidden" id="cliModo">

                <div class="form-group"><label>Nombre:</label><input type="text" id="cliNom"></div>
                <div class="form-group"><label>C茅dula/NIT:</label><input type="text" id="cliCed"></div>
                <div class="form-group"><label>Tel茅fono:</label><input type="text" id="cliTel"></div>
                <div class="form-group"><label>Correo:</label><input type="text" id="cliCor"></div>
                <div class="form-group"><label>Direcci贸n:</label><input type="text" id="cliDir"></div>
                <div class="form-group"><label>Presupuesto/Valor:</label><input type="text" id="cliPre"></div>
                <div class="form-group"><label>Tipo Servicio:</label>
                    <select id="cliTipo">
                        <option value="VENTA">VENTA</option>
                        <option value="ADMINISTRACION">ADMINISTRACION</option>
                        <option value="CREDITO/SUBSIDIO">CREDITO/SUBSIDIO</option>
                    </select>
                </div>

                <div class="form-group" id="divCliEst">
                    <label>Estado:</label>
                    <select id="cliEst">
                        <option value="PENDIENTE">PENDIENTE</option><option value="EN PROCESO">EN PROCESO</option>
                        <option value="COMPLETADA">COMPLETADA</option><option value="CANCELADA">CANCELADA</option>
                    </select>
                </div>
                <div class="form-group" id="divCliNotas"><label>Notas / Observaciones:</label><textarea id="cliNotas"></textarea></div>
            </div>
            <div class="modal-footer">
                <button class="btn-save" onclick="guardarCliente()">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script>
        // --- TU URL DE APPS SCRIPT (CONSERVADA) ---
        const API = "https://script.google.com/macros/s/AKfycbxomLdB31kWJ6rsv5Uat6G6E3k1nvM_s2mr855DB1Oh4gSVoW1huSk2BOEqZa__WwMe/exec";

        let dAct = [], dCli = [];

        // AL CARGAR LA PGINA
        window.onload = () => {
            cargarActividades();
            cargarClientes(true); // Carga silenciosa para llenar el dropdown
        };

        function verModulo(m) {
            document.querySelectorAll('.module').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById('mod-'+m).classList.add('active');
            event.target.classList.add('active');
        }

        // --- CARGA DE DATOS ---
        async function cargarActividades() {
            try {
                let r = await fetch(API + "?action=read_actividades");
                let j = await r.json();
                if(j.status === 'success') { dAct = j.data; renderActividades(); }
            } catch(e) { console.error(e); }
        }

        async function cargarClientes(silencioso = false) {
            if(!silencioso) document.getElementById('loading').style.display = 'block';
            try {
                let r = await fetch(API + "?action=read_clientes");
                let j = await r.json();
                if(j.status === 'success') { dCli = j.data; renderClientes(); }
            } catch(e) { console.error(e); }
            if(!silencioso) document.getElementById('loading').style.display = 'none';
        }

        // --- RENDERIZADO (TABLAS) ---
        function renderActividades() {
            let tb = document.getElementById('tblActividades');
            tb.innerHTML = "";
            let fF = document.getElementById('fActFecha').value;
            let fR = document.getElementById('fActResp').value;
            let fE = document.getElementById('fActEstado').value;

            // Filtros usando MAYSCULAS
            let fil = dAct.filter(i => {
                let fechaOk = true;
                if(fF) {
                    fechaOk = (i.FECHA && i.FECHA.includes(fF)) || (new Date(i.FECHA).toISOString().startsWith(fF));
                }
                let respOk = !fR || i.RESPONSABLE == fR;
                let estOk = !fE || i.ESTADO == fE;
                return fechaOk && respOk && estOk;
            });

            if(fil.length === 0) tb.innerHTML = "<tr><td colspan='6' style='text-align:center'>No hay datos</td></tr>";

            fil.forEach(i => {
                let tr = document.createElement('tr');
                tr.onclick = () => abrirModalActividad(false, i);
                let fechaStr = i.FECHA ? new Date(i.FECHA).toLocaleDateString() : '';
                tr.innerHTML = `<td>${fechaStr}</td><td>${i.CLIENTE}</td><td>${i.ACTIVIDAD}</td><td>${i.RESPONSABLE}</td>
                                <td><span class="badge ${color(i.ESTADO)}">${i.ESTADO}</span></td><td><small>${i.NOTAS||''}</small></td>`;
                tb.appendChild(tr);
            });
        }

        function renderClientes() {
            let tb = document.getElementById('tblClientes');
            tb.innerHTML = "";
            let fT = document.getElementById('fCliTipo').value;
            let fE = document.getElementById('fCliEstado').value;

            // Usando claves MAYSCULAS
            let fil = dCli.filter(i => (!fT || i.TIPO_SERVICIO == fT) && (!fE || i.ESTADO_CLIENTE == fE));
            
            if(fil.length === 0) tb.innerHTML = "<tr><td colspan='6' style='text-align:center'>No hay datos</td></tr>";

            fil.forEach(i => {
                let tr = document.createElement('tr');
                tr.onclick = () => abrirModalCliente(false, i);
                tr.innerHTML = `<td>${i.NOMBRE}</td><td>${i.CEDULA_NIT}</td><td>${i.TELEFONO}</td><td>${i.TIPO_SERVICIO}</td>
                                <td><span class="badge ${color(i.ESTADO_CLIENTE)}">${i.ESTADO_CLIENTE}</span></td><td><small>${i.NOTAS||''}</small></td>`;
                tb.appendChild(tr);
            });
        }

        // --- GESTIN DE MODALES ---
        
        // 1. Modal Actividad (Con Dropdown de Clientes)
        function abrirModalActividad(esNuevo, item) {
            document.getElementById('modalActividad').style.display = 'block';
            
            // Llenar SELECT de Clientes
            let sel = document.getElementById('actCliente');
            sel.innerHTML = '<option value="">Seleccione Cliente...</option>';
            dCli.sort((a,b) => (a.NOMBRE || "").localeCompare(b.NOMBRE || "")).forEach(c => {
                let opt = document.createElement('option');
                opt.value = c.NOMBRE; 
                opt.text = c.NOMBRE; 
                sel.appendChild(opt);
            });

            if(esNuevo) {
                document.getElementById('tModalAct').innerText = "Nueva Actividad";
                document.getElementById('actModo').value = "create";
                document.getElementById('actId').value = "";
                
                // Limpiar
                sel.value = "";
                document.getElementById('actDesc').value = "";
                document.getElementById('actResp').value = "";
                document.getElementById('actNotas').value = "";
                
                // Habilitar campos
                sel.disabled = false;
                document.getElementById('actDesc').disabled = false;
                document.getElementById('actResp').disabled = false;

                // Ocultar campos autom谩ticos
                document.getElementById('divActEst').style.display = 'none';
                document.getElementById('divActNotas').style.display = 'none';
            } else {
                document.getElementById('tModalAct').innerText = "Editar Actividad";
                document.getElementById('actModo').value = "edit";
                document.getElementById('actId').value = item.ID;
                
                // Cargar datos
                sel.value = item.CLIENTE;
                document.getElementById('actDesc').value = item.ACTIVIDAD;
                document.getElementById('actResp').value = item.RESPONSABLE;
                document.getElementById('actEst').value = item.ESTADO;
                document.getElementById('actNotas').value = item.NOTAS;

                // Bloquear campos fijos
                sel.disabled = true;
                document.getElementById('actDesc').disabled = true;
                document.getElementById('actResp').disabled = true;

                // Mostrar campos editables
                document.getElementById('divActEst').style.display = 'block';
                document.getElementById('divActNotas').style.display = 'block';
            }
        }

        // 2. Modal Cliente
        function abrirModalCliente(esNuevo, item) {
            document.getElementById('modalCliente').style.display = 'block';
            let ids = ['cliNom','cliCed','cliTel','cliCor','cliDir','cliPre','cliTipo'];
            
            if(esNuevo) {
                document.getElementById('tModalCli').innerText = "Nuevo Cliente";
                document.getElementById('cliModo').value = "create";
                document.getElementById('cliId').value = "";
                
                ids.forEach(id => { 
                    let el = document.getElementById(id); 
                    el.value=""; 
                    el.disabled=false; 
                });

                document.getElementById('divCliEst').style.display = 'none';
                document.getElementById('divCliNotas').style.display = 'none';
            } else {
                document.getElementById('tModalCli').innerText = "Editar Cliente";
                document.getElementById('cliModo').value = "edit";
                
                // Cargar datos
                document.getElementById('cliId').value = item.ID_CLIENTE;
                document.getElementById('cliNom').value = item.NOMBRE;
                document.getElementById('cliCed').value = item.CEDULA_NIT;
                document.getElementById('cliTel').value = item.TELEFONO;
                document.getElementById('cliCor').value = item.CORREO;
                document.getElementById('cliDir').value = item.DIRECCION;
                document.getElementById('cliPre').value = item.PRESUPUESTO;
                document.getElementById('cliTipo').value = item.TIPO_SERVICIO;
                document.getElementById('cliEst').value = item.ESTADO_CLIENTE;
                document.getElementById('cliNotas').value = item.NOTAS;

                // Bloquear todo menos estado y notas
                ids.forEach(id => document.getElementById(id).disabled = true);
                
                document.getElementById('divCliEst').style.display = 'block';
                document.getElementById('divCliNotas').style.display = 'block';
            }
        }

        // --- ENVIAR DATOS ---
        async function guardarActividad() {
            let modo = document.getElementById('actModo').value;
            let btn = document.querySelector('#modalActividad .btn-save');
            
            // Validaci贸n b谩sica
            if(modo == 'create' && !document.getElementById('actCliente').value) return alert("Seleccione un cliente");
            if(modo == 'create' && !document.getElementById('actResp').value) return alert("Seleccione un responsable");

            let fd = new FormData();
            if(modo=='create') {
                fd.append('action','create_actividad');
                fd.append('cliente', document.getElementById('actCliente').value);
                fd.append('actividad', document.getElementById('actDesc').value);
                fd.append('responsable', document.getElementById('actResp').value);
            } else {
                fd.append('action','update_actividad');
                fd.append('id', document.getElementById('actId').value);
                fd.append('estado', document.getElementById('actEst').value);
                fd.append('notas', document.getElementById('actNotas').value);
            }
            await enviar(fd, btn, cargarActividades);
        }

        async function guardarCliente() {
            let modo = document.getElementById('cliModo').value;
            let btn = document.querySelector('#modalCliente .btn-save');
            let fd = new FormData();
            
            if(modo=='create') {
                fd.append('action','create_cliente');
                fd.append('nombre', document.getElementById('cliNom').value);
                fd.append('cedula', document.getElementById('cliCed').value);
                fd.append('telefono', document.getElementById('cliTel').value);
                fd.append('correo', document.getElementById('cliCor').value);
                fd.append('direccion', document.getElementById('cliDir').value);
                fd.append('presupuesto', document.getElementById('cliPre').value);
                fd.append('tipo', document.getElementById('cliTipo').value);
            } else {
                fd.append('action','update_cliente');
                fd.append('id', document.getElementById('cliId').value);
                fd.append('estado', document.getElementById('cliEst').value);
                fd.append('notas', document.getElementById('cliNotas').value);
            }
            await enviar(fd, btn, () => { cargarClientes(); cargarActividades(); });
        }

        async function enviar(fd, btn, callback) {
            btn.disabled = true;
            btn.innerText = "Guardando...";
            try { 
                await fetch(API, {method:'POST', body:fd}); 
                alert("Guardado exitosamente"); 
                cerrarModales();
                if(callback) callback(); 
            }
            catch(e){ console.error(e); alert("Hubo un error al guardar"); }
            btn.disabled = false;
            btn.innerText = "Guardar Cambios";
        }

        function cerrarModales() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
        
        function color(e) {
            if(!e) return '';
            if(e=='PENDIENTE') return 'bg-pendiente';
            if(e=='EN PROCESO') return 'bg-proceso';
            if(e=='COMPLETADA') return 'bg-completada';
            if(e=='CANCELADA') return 'bg-cancelada';
            return '';
        }

        // Cerrar al dar clic fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) cerrarModales();
        }
    </script>
</body>
</html>